<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="lib/qrcode.js"></script>
    <script src="lib/jquery.js"></script>
    <script src="lib/jquery.qrcode.js"></script>
    <script src="lib/jquery.cookie.js"></script>

</head>
<body>
<div id="qrcode"></div>
<button id="showBtn" onclick="showQRcode()" style="display: none;">显示二维码</button>
<form id="loginForm">
    <input id="admin_code" type="hidden" name="admin_code">
    <input id="code" type="hidden" name="code">
</form>
<script type="text/javascript">

    // 浏览器提供 WebSocket 对象
    var ws = new WebSocket('wss://www.hnsjb.cn/websocket/');
    // var ws = new WebSocket('ws://127.0.0.1:2727/');

    // 发送
    ws.onopen = function () {
        if (ws.readyState >= 1) {
            $('#showBtn').show()
        } else {
            alert('连接失败，请重试！')
        }
    };

    // 接收
    ws.onmessage = function (msg) {
        var resData = JSON.parse(msg.data);
        if (resData.type === 'receivedId') {
            $('#qrcode').qrcode({
                render: "canvas", //也可以替换为table
                width: 200,
                height: 200,
                text: 'http://www.henandaily.cn/content/special/test2/mobileLogin.html?id=' + resData.clientid
            });
        } else if (resData.type == 'pcLogin') {
            $.get(resData.reqUrl, function (res) {
                var json = JSON.parse(res);
                if (json.status == 1) {
                    console.log(json);
                    for (var key in json.data) {
                        $.cookie(key, json.data[key], {expires: 30, path: '/'});
                    }

                    setTimeout(function () {
                        window.location.href = '/index.php?m=admin&c=index&a=init'
                    }, 3000);
                } else {
                    alert(json.message)
                }
            })
        } else {
            alert('网络错误请刷新重试！')
        }
    };

    ws.onclose = function (msg) {

    };

    ws.onerror = function () {
        alert('连接未就绪，请稍后再试！')
    };

    function showQRcode() {
        ws.send('reqAuthId')
    }
</script>
</body>
</html>